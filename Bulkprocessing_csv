import os
import pandas as pd
import json
import tkinter as tk
from tkinter import filedialog, messagebox

def process_fixed_width_files(folder_path, config_path):
    """
    處理資料夾中的檔案，根據固定寬度分割規則和欄位命名進行處理。
    
    :param folder_path: 資料夾路徑
    :param config_path: JSON 設定檔路徑
    """
    try:
        # 讀取設定檔
        with open(config_path, 'r') as f:
            config = json.load(f)

        files = os.listdir(folder_path)

        for file_name in files:
            file_path = os.path.join(folder_path, file_name)

            if os.path.isfile(file_path) and file_name in config:
                widths = config[file_name]["widths"]
                columns = config[file_name]["columns"]

                try:
                    # 使用固定寬度讀取檔案
                    df = pd.read_fwf(file_path, widths=widths, header=None)
                    df.columns = columns

                    # 儲存處理後的檔案
                    processed_file_path = os.path.join(folder_path, f"processed_{file_name}")
                    df.to_csv(processed_file_path, index=False)
                    print(f"已處理並存檔: {processed_file_path}")
                except Exception as e:
                    messagebox.showerror("錯誤", f"處理檔案 {file_name} 時發生錯誤: {e}")

        messagebox.showinfo("完成", "所有檔案已處理完成！")
    except Exception as e:
        messagebox.showerror("錯誤", f"讀取設定檔時發生錯誤: {e}")

def select_folder_and_process():
    folder_path = filedialog.askdirectory(title="選擇資料夾")
    if folder_path:
        config_path = filedialog.askopenfilename(title="選擇設定檔", filetypes=[("JSON files", "*.json")])
        if config_path:
            process_fixed_width_files(folder_path, config_path)

# 建立 GUI 視窗
root = tk.Tk()
root.title("固定寬度檔案處理工具")
root.geometry("400x200")

label = tk.Label(root, text="請選擇包含要處理檔案的資料夾和設定檔", font=("Arial", 12))
label.pack(pady=20)

select_button = tk.Button(root, text="選擇資料夾並處理", font=("Arial", 12), command=select_folder_and_process)
select_button.pack(pady=20)

# 啟動主迴圈
root.mainloop()
